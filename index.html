<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EAN Preis Rechner</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 24px; max-width: 980px; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 6px; min-width: 180px; }
    label { font-size: 12px; opacity: 0.8; }
    input, select, button { padding: 10px 12px; font-size: 14px; }
    input, select { border: 1px solid #ccc; border-radius: 8px; }
    input[disabled] { background: #f5f5f5; }
    button { border: 0; border-radius: 10px; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.ghost { background: #eee; }
    button.danger { background: #b00020; color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 10px; border-bottom: 1px solid #e6e6e6; text-align: left; vertical-align: middle; }
    th { font-size: 12px; opacity: 0.8; }
    .hint { margin-top: 10px; font-size: 12px; opacity: 0.8; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f2f2f2; font-size: 12px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>EAN Preis Rechner <span class="pill">Rundung auf ,x9</span></h1>

  <div class="row">
    <div class="field">
      <label for="ean">EAN</label>
      <input id="ean" inputmode="numeric" placeholder="z. B. 4006381333931" />
    </div>

    <div class="field">
      <label for="price">Preis</label>
      <input id="price" inputmode="decimal" placeholder="z. B. 19,99" />
    </div>

    <div class="field">
      <label for="percent">Abzug in Prozent</label>
      <select id="percent"></select>
    </div>

    <div class="field">
      <label for="result">Preis nach Abzug (gerundet)</label>
      <input id="result" disabled />
    </div>

    <div class="field">
      <button class="primary" id="add">Zur Liste hinzufügen</button>
    </div>
  </div>

  <div class="row" style="margin-top: 12px;">
    <button class="ghost" id="export">CSV exportieren (nur EAN + Preis)</button>
    <button class="danger" id="clear">Liste leeren</button>
  </div>

  <table aria-label="Liste">
    <thead>
      <tr>
        <th>EAN</th>
        <th>Original Preis</th>
        <th>Abzug</th>
        <th>Preis nach Abzug (gerundet)</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="hint">
    Bearbeiten geht direkt in der Tabelle (EAN, Preis, Prozent). Danach wird automatisch neu gerechnet und auf ,x9 gerundet.
    Export enthält nur zwei Spalten: EAN und PreisNachAbzug.
  </div>

  <script>
    const eanEl = document.getElementById("ean");
    const priceEl = document.getElementById("price");
    const percentEl = document.getElementById("percent");
    const resultEl = document.getElementById("result");
    const tbody = document.getElementById("tbody");

    const addBtn = document.getElementById("add");
    const exportBtn = document.getElementById("export");
    const clearBtn = document.getElementById("clear");

    let rows = [];

    function initPercentDropdown(selectEl, selectedValue) {
      selectEl.innerHTML = "";
      for (let p = 2; p <= 50; p++) {
        const opt = document.createElement("option");
        opt.value = String(p);
        opt.textContent = p + "%";
        if (String(p) === String(selectedValue)) opt.selected = true;
        selectEl.appendChild(opt);
      }
    }

    function parsePrice(value) {
      if (!value) return NaN;
      const normalized = value.trim().replace(/\s+/g, "").replace(",", ".");
      const num = Number(normalized);
      return Number.isFinite(num) ? num : NaN;
    }

    function formatPrice(num) {
      if (!Number.isFinite(num)) return "";
      return num.toFixed(2).replace(".", ",");
    }

    // Rundung auf ,x9: immer AUFRUNDEN auf die nächste 10er-Cent-Stufe + 9 Cent
    // Beispiele: 12,31 -> 12,39 | 12,39 -> 12,39 | 12,90 -> 12,99 | 12,99 -> 12,99
    function roundToX9(value) {
      if (!Number.isFinite(value)) return NaN;
      let euros = Math.floor(value);
      let cents = Math.ceil((value - euros) * 100 - 1e-9); // kleine Toleranz gegen Floating-Fehler
      // auf nächste 10er-Stufe (aufgerundet) und dann +9
      let tens = Math.ceil(cents / 10);
      cents = tens * 10 + 9;
      if (cents >= 100) {
        euros += 1;
        cents = 9;
      }
      return euros + cents / 100;
    }

    function calcDiscounted(price, percent) {
      const factor = 1 - (percent / 100);
      return price * factor;
    }

    function updatePreview() {
      const price = parsePrice(priceEl.value);
      const percent = Number(percentEl.value);
      if (!Number.isFinite(price) || !Number.isFinite(percent)) {
        resultEl.value = "";
        return;
      }
      const discounted = calcDiscounted(price, percent);
      const rounded = roundToX9(discounted);
      resultEl.value = formatPrice(rounded);
    }

    function sanitizeEan(ean) {
      return (ean || "").trim();
    }

    function render() {
      tbody.innerHTML = "";

      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");

        // EAN editable
        const tdEan = document.createElement("td");
        const eanInput = document.createElement("input");
        eanInput.value = r.ean;
        eanInput.placeholder = "EAN";
        eanInput.addEventListener("input", () => {
          rows[idx].ean = sanitizeEan(eanInput.value);
        });
        tdEan.appendChild(eanInput);

        // Price editable
        const tdPrice = document.createElement("td");
        const priceInput = document.createElement("input");
        priceInput.value = formatPrice(r.price);
        priceInput.placeholder = "Preis";
        priceInput.inputMode = "decimal";
        priceInput.addEventListener("input", () => {
          const p = parsePrice(priceInput.value);
          rows[idx].price = Number.isFinite(p) ? p : NaN;
          recalcRow(idx);
          render(); // refresh computed cells and keep logic simple
        });
        tdPrice.appendChild(priceInput);

        // Percent editable
        const tdPercent = document.createElement("td");
        const pctSelect = document.createElement("select");
        initPercentDropdown(pctSelect, r.percent);
        pctSelect.addEventListener("change", () => {
          rows[idx].percent = Number(pctSelect.value);
          recalcRow(idx);
          render();
        });
        tdPercent.appendChild(pctSelect);

        // Discounted computed
        const tdDiscounted = document.createElement("td");
        tdDiscounted.textContent = Number.isFinite(r.discountedRounded) ? formatPrice(r.discountedRounded) : "";

        // Actions
        const tdAction = document.createElement("td");
        const wrap = document.createElement("div");
        wrap.className = "actions";

        const del = document.createElement("button");
        del.className = "ghost";
        del.textContent = "Löschen";
        del.addEventListener("click", () => {
          rows.splice(idx, 1);
          render();
        });

        wrap.appendChild(del);
        tdAction.appendChild(wrap);

        tr.appendChild(tdEan);
        tr.appendChild(tdPrice);
        tr.appendChild(tdPercent);
        tr.appendChild(tdDiscounted);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    function recalcRow(i) {
      const r = rows[i];
      const price = r.price;
      const percent = r.percent;

      if (!Number.isFinite(price) || !Number.isFinite(percent)) {
        r.discounted = NaN;
        r.discountedRounded = NaN;
        return;
      }
      const discounted = calcDiscounted(price, percent);
      r.discounted = discounted;
      r.discountedRounded = roundToX9(discounted);
    }

    function addRow() {
      const ean = sanitizeEan(eanEl.value);
      const price = parsePrice(priceEl.value);
      const percent = Number(percentEl.value);

      if (!ean) { alert("Bitte eine EAN eingeben."); return; }
      if (!Number.isFinite(price)) { alert("Bitte einen gültigen Preis eingeben."); return; }
      if (!(percent >= 2 && percent <= 50)) { alert("Ungültiger Prozentwert."); return; }

      const discounted = calcDiscounted(price, percent);
      const discountedRounded = roundToX9(discounted);

      rows.push({ ean, price, percent, discounted, discountedRounded });
      render();

      eanEl.value = "";
      priceEl.value = "";
      updatePreview();
      eanEl.focus();
    }

    function toCsvValue(v) {
      const s = String(v ?? "");
      if (/[",\n;]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }

    function exportCsv() {
      if (rows.length === 0) {
        alert("Liste ist leer. Erst ein paar Zeilen hinzufügen.");
        return;
      }

      // Validieren und neu rechnen, falls jemand ungültige Preise eingetippt hat
      rows.forEach((_, i) => recalcRow(i));

      const header = ["EAN", "PreisNachAbzug"];
      const lines = [header.join(";")];

      rows.forEach(r => {
        if (!r.ean) return;
        if (!Number.isFinite(r.discountedRounded)) return;
        const line = [
          toCsvValue(r.ean),
          toCsvValue(formatPrice(r.discountedRounded))
        ].join(";");
        lines.push(line);
      });

      if (lines.length === 1) {
        alert("Keine gültigen Zeilen zum Export (EAN und Preis prüfen).");
        return;
      }

      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "ean_preise_x9.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    function clearAll() {
      if (!rows.length) return;
      if (!confirm("Wirklich alles löschen?")) return;
      rows = [];
      render();
    }

    // Init
    initPercentDropdown(percentEl, 10);
    priceEl.addEventListener("input", updatePreview);
    percentEl.addEventListener("change", updatePreview);

    addBtn.addEventListener("click", addRow);
    exportBtn.addEventListener("click", exportCsv);
    clearBtn.addEventListener("click", clearAll);

    // Enter Support: Enter im Preisfeld oder EAN Feld fügt hinzu
    [eanEl, priceEl].forEach(el => {
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter") addRow();
      });
    });

    updatePreview();
  </script>
</body>
</html>
